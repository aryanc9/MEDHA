rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users can read and create their own profile.
    // They can only update their own profile.
    // Score can only be incremented, not set arbitrarily.
    match /users/{userId} {
      allow read, create: if request.auth != null && request.auth.uid == userId;

      // Allow updates to all fields except studentScore if the user is the owner.
      // The studentScore can only be incremented, not directly set, preventing cheating.
      allow update: if request.auth.uid == userId &&
                       // Check that the incoming resource is not overwriting protected fields.
                       !(request.resource.data.studentScore is number) &&
                       // Allow incrementing the score. The diff will be a number.
                       (request.resource.data.studentScore == request.resource.data.diff(1).studentScore + 1);

      // A user can read, write, and delete their own courses.
      match /courses/{courseId} {
        allow read, write, delete: if request.auth.uid == userId;
      }

      // A user can read, write, and delete their own conversations.
      match /conversations/{conversationId} {
        allow read, write, delete: if request.auth.uid == userId;
      }
    }
  }
}
